<head>
  <title>incredible2</title>
</head>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script>
  var conn;
  var worldData;
  var deadLastFrame = true;

  function sendKey(code, down) {
    if ((code >= 37 && code <= 40) || code == 32) {
      console.log(code)
      conn.send(JSON.stringify({Code: code, Down: down}))
      return false
    }
    return true
  }

  $(function() {

    $("body").css('overflow', 'hidden');

    $(document).bind('keydown', function (evt){
      if (sendKey(evt.keyCode, true)) {
        evt.preventDefault();
      }
    });

    $(document).bind('keyup', function (evt){
      if (sendKey(evt.keyCode, false)) {
        evt.preventDefault();
      }
    });

    function drawDead() {
      $('#screen').hide();
      $('#dead').show();
    }

    function drawGame() {
      var canvas = document.getElementById('screen');
      var ctx = canvas.getContext('2d');
      ctx.fillStyle="black";
      ctx.fillRect(0,0,640,480);

      for (i = 0; i < data.Players.length; ++i) {
        ctx.beginPath();
        ship = data.Players[i];

        point1x = ship.X + 10 * (Math.sin(ship.Direction));
        point1y = ship.Y + 10 * (Math.cos(ship.Direction));
        point2x = ship.X - 10 * (Math.sin(ship.Direction + 0.35));
        point2y = ship.Y - 15 * (Math.cos(ship.Direction + 0.35));
        point3x = ship.X - 10 * (Math.sin(ship.Direction - 0.35));
        point3y = ship.Y - 15 * (Math.cos(ship.Direction - 0.35));

        ctx.lineWidth = 2;
        ctx.strokeStyle = '#00AA00';

        ctx.moveTo(point1x, point1y);
        ctx.lineTo(point2x, point2y);
        ctx.lineTo(point3x, point3y);
        ctx.lineTo(point1x, point1y);
        ctx.stroke();	
      }
      for (i = 0; i < data.Bullets.length; ++i) {
        ctx.beginPath();
        bullet = data.Bullets[i].Position;

        point1x = bullet.X;
        point1y = bullet.Y;
        point2x = bullet.X + 5 * (Math.sin(bullet.Direction));
        point2y = bullet.Y + 5 * (Math.cos(bullet.Direction));

        ctx.lineWidth = 2;
        ctx.strokeStyle = '#00FF00';

        ctx.moveTo(point1x, point1y);
        ctx.lineTo(point2x, point2y);
        ctx.stroke();	
      }

    }

    function drawScreen(timestamp) {
      data = worldData;
      if (data === undefined) {
        drawDead();
        window.requestAnimationFrame(drawScreen);
        return
      }

      if (data.Playing == true) {
        if (deadLastFrame == true) {
          $('#dead').hide();
          $('#screen').show();
        }
        drawGame()
        deadLastFrame = false;
      } else {
        drawDead()
        deadLastFrame = true;
      }

      window.requestAnimationFrame(drawScreen);
    }

    if (window["WebSocket"]) {
      conn = new WebSocket("ws://{{$}}/ws");
      conn.onclose = function(evt) {
        debugger
        console.log("<div><b>Connection closed.</b></div>")
      }
      conn.onmessage = function(evt) {
        worldData = JSON.parse(evt.data);
      }
      conn.onerror = function(evt) {
        debugger
      }
      window.setInterval(function() {
        conn.send("PONG")
      }, 5000)

      window.requestAnimationFrame(drawScreen);
    }
  });
</script>

<body>

  <canvas id="screen" width="640" height="480" style="width:100%; height: 100%"></canvas>

  <div id="gameover"><p>Game over!</div>
</body>
